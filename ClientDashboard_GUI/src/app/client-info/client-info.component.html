@if(clients === null){
  <app-spinner></app-spinner>
}
@else {

<p-toast />

  <!-- Add Dialog - Moved outside table -->
  <p-dialog header="Add new Client" [modal]="true" [(visible)]="addDialogVisible" [style]="{ width: '25rem' }">
      <span class="p-text-secondary block mb-8">Enter new client details:</span>
      <div class="flex items-center gap-4 mb-4">
          <label for="clientName" class="font-semibold w-24">Client Name</label>
          <input pInputText [(ngModel)]="newClientName" id="clientName" class="flex-auto" autocomplete="off" />
      </div>
      <div class="flex items-center gap-4 mb-8">
          <label for="totalBlockSessions" class="font-semibold w-24">Total Block Sessions</label>
          <p-inputnumber inputId="totalBlockSessions" [(ngModel)]="newTotalBlockSessions" id="totalBlockSessions" class="flex-auto" autocomplete="off" />
      </div>
       <div class="flex items-center gap-4 mb-4">
          <label for="phoneNumber" class="font-semibold w-24">Phone Number</label>
          <input pInputText [(ngModel)]="newPhoneNumber" id="phoneNumber" class="flex-auto" autocomplete="off" />
      </div>
      <div class="flex justify-end gap-2">
          <p-button label="Cancel" severity="secondary" (click)="addDialogVisible = false" />
          <p-button label="Save" (click)="addNewClient(newClientName, newTotalBlockSessions, newPhoneNumber)"/>
      </div>
  </p-dialog>

  <!-- Delete Dialog - Moved outside table -->
  <p-dialog header="Delete Client" [modal]="true" [(visible)]="deleteDialogVisible" [style]="{ width: '25rem' }">
    <div class="delete-message">
      <span class="p-text-secondary block mb-8">Are you sure you want to delete client {{deleteClientName}} from your table?</span>
    </div>
      <div class="flex justify-end gap-2">
          <p-button label="Cancel" severity="secondary" (click)="deleteDialogVisible = false" />
          <p-button label="Delete" (click)=" onRowDelete(deleteClientId)" />
      </div>
  </p-dialog>

  <!-- Phone Number Dialog -->
  <p-dialog header="Phone Number" [modal]="true" [(visible)]="phoneDialogVisible" [style]="{ width: '25rem' }">
    <span class="p-text-secondary block mb-4">Set {{editingClientName}}'s phone number below:</span>
    <div class="flex items-center gap-4 mb-8">
        <label for="phoneNumber" class="font-semibold w-32">Phone Number</label>
        <input 
            pInputText 
            [(ngModel)]="editingPhoneNumber" 
            id="phoneNumber" 
            class="flex-auto" 
            placeholder="+44 7700 900000"
            autocomplete="off" 
        />
    </div>
    <div class="flex justify-end gap-2">
        <p-button label="Cancel" severity="secondary" (click)="phoneDialogVisible = false" />
        <p-button label="Save" (click)="savePhoneNumber()" />
    </div>
</p-dialog>

  <div class="table-container">
  <p-table [value]="clients" dataKey="id" editMode="row" [tableStyle]="{ 'min-width': '50rem' }">
      <ng-template #header>
        <div class="card flex justify-center">
          <p-button icon="pi pi-plus" label="New" severity="secondary" (onClick)="showDialogForAdd()"></p-button>
        </div>
          <tr>
              <th pSortableColumn="firstName" style="width:25%; text-align: center;">
                    Client Name <p-sortIcon field="firstName" />
              </th>
              <th pSortableColumn="currentBlockSession" style="width:25%; text-align: center;">
                    Current Session <p-sortIcon field="currentBlockSession" />
              </th>
              <th pSortableColumn="totalBlockSessions" style="width:25%; text-align: center;">
                    Block Sessions <p-sortIcon field="totalBlockSessions" />
              </th>
              <th pSortableColumn="isActive" style="width:25%; text-align: center;">
                    Activity Status <p-sortIcon field="isActive" />
              </th>
          </tr>
      </ng-template>
      <ng-template #body let-client let-editing="editing" let-ri="rowIndex">
          <tr [pEditableRow]="client">
              <td class="client-td">
                <p-cellEditor>
                    <ng-template #input>
                        <input
                            pInputText type="text"
                            [(ngModel)]= "client.firstName" />
                    </ng-template>
                    <ng-template #output>
                        {{client.firstName}}
                    </ng-template>
                </p-cellEditor>
              </td>
              <td class="client-td">
                <p-cellEditor>
                    <ng-template #input>
                        <input
                            pInputText type="text"
                            [(ngModel)]= "client.currentBlockSession" />
                    </ng-template>
                    <ng-template #output>
                        {{client.currentBlockSession}}
                    </ng-template>
                </p-cellEditor>
              </td>
              <td class="client-td">
                <p-cellEditor>
                    <ng-template #input>
                        <input
                            pInputText type="text"
                            [(ngModel)]= "client.totalBlockSessions" />
                    </ng-template>
                    <ng-template #output>
                        {{client.totalBlockSessions}}
                    </ng-template>
                </p-cellEditor>
              </td>
              <td class="client-td">
                <p-cellEditor>
                    <ng-template #input>
                        <p-select
                            [options]="activityStatuses"
                          appendTo="body"
                            [(ngModel)]= "client.isActive"
                            [style]="{'width':'100%'}" 
                            />
                    </ng-template>
                    <ng-template #output>
                         <p-tag
                            [value]="getActivityLabel(client.isActive)"
                            [severity]="getActivities(client.isActive)" />
                    </ng-template>
                </p-cellEditor>
              </td>
              <td class="client-td action-column">
                <div class="flex items-center justify-center gap-2 flex-wrap">
                  <a [href]="`https://wa.me/${client.phoneNumber}`" target="_blank" rel="noopener noreferrer">
                    <button
                      *ngIf="!editing"
                      pButton
                      pRipple
                      severity="secondary"
                      icon="pi pi-whatsapp"
                      rounded
                    ></button></a>
                    <button
                      *ngIf="!editing"
                      pButton
                      pRipple
                      severity="secondary"
                      icon="pi pi-chart-line"
                      rounded
                    ></button>
                    <p-button 
                        *ngIf="editing"
                        (onClick)="showPhoneDialog(client)"
                        icon="pi pi-phone"
                        severity="secondary"
                    />
                    <button
                        *ngIf="!editing"
                        pButton
                        pRipple
                        type="button"
                        pInitEditableRow
                        icon="pi pi-pencil"
                        (click)="onRowEditInit(client)"
                        text
                        rounded
                        severity="secondary"
                    ></button>
                    <button
                        *ngIf="editing"
                        pButton
                        pRipple
                        type="button"
                        pSaveEditableRow
                        icon="pi pi-check"
                        (click)="onRowEditSave(client)"
                        text
                        rounded
                        severity="secondary"
                    ></button>
                    <button
                        *ngIf="editing"
                        pButton
                        pRipple
                        type="button"
                        pCancelEditableRow
                        icon="pi pi-times"
                        (click)="onRowEditCancel(client, ri)"
                        text
                        rounded
                        severity="secondary"
                    ></button>
                    <button
                        *ngIf="editing"
                        pButton
                        pRipple
                        type="button"
                        icon="pi pi-trash"
                        (click)="showDialogForDelete(client.id, client.name)"
                        text
                        rounded
                        severity="secondary"
                    ></button>
                    
                </div>
            </td>
        </tr>
      </ng-template>
  </p-table>
</div>
}
